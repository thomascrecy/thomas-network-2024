# TP2 : Environnement virtuel

## I. Topologie réseau

### ☀️ Sur node1.lan1.tp2
```
[toto@node1 ~]$ ip a
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
2: enp0s3: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000
    link/ether 08:00:27:66:1a:e5 brd ff:ff:ff:ff:ff:ff
    inet 10.1.1.11/24 brd 10.1.1.255 scope global noprefixroute enp0s3
       valid_lft forever preferred_lft forever
    inet6 fe80::a00:27ff:fe66:1ae5/64 scope link
       valid_lft forever preferred_lft forever
```
```
[toto@node1 ~]$ ip route
10.1.1.0/24 dev enp0s3 proto kernel scope link src 10.1.1.11 metric 100
10.1.2.0/24 via 10.1.1.254 dev enp0s3
10.1.2.0/24 via 10.1.1.254 dev enp0s3 proto static metric 100
```
```
[toto@node1 ~]$ ping 10.1.2.11
PING 10.1.2.11 (10.1.2.11) 56(84) bytes of data.
64 bytes from 10.1.2.11: icmp_seq=1 ttl=63 time=2.96 ms
64 bytes from 10.1.2.11: icmp_seq=2 ttl=63 time=3.98 ms
64 bytes from 10.1.2.11: icmp_seq=3 ttl=63 time=4.33 ms
64 bytes from 10.1.2.11: icmp_seq=4 ttl=63 time=2.55 ms
64 bytes from 10.1.2.11: icmp_seq=5 ttl=63 time=2.47 ms
64 bytes from 10.1.2.11: icmp_seq=6 ttl=63 time=3.96 ms
64 bytes from 10.1.2.11: icmp_seq=7 ttl=63 time=4.68 ms
64 bytes from 10.1.2.11: icmp_seq=8 ttl=63 time=3.25 ms
64 bytes from 10.1.2.11: icmp_seq=9 ttl=63 time=4.89 ms
64 bytes from 10.1.2.11: icmp_seq=10 ttl=63 time=4.45 ms
64 bytes from 10.1.2.11: icmp_seq=11 ttl=63 time=4.57 ms
64 bytes from 10.1.2.11: icmp_seq=12 ttl=63 time=5.31 ms
64 bytes from 10.1.2.11: icmp_seq=13 ttl=63 time=4.16 ms
64 bytes from 10.1.2.11: icmp_seq=14 ttl=63 time=4.02 ms
64 bytes from 10.1.2.11: icmp_seq=15 ttl=63 time=4.37 ms
64 bytes from 10.1.2.11: icmp_seq=16 ttl=63 time=3.87 ms
64 bytes from 10.1.2.11: icmp_seq=17 ttl=63 time=4.52 ms
^C
--- 10.1.2.11 ping statistics ---
17 packets transmitted, 17 received, 0% packet loss, time 16044ms
rtt min/avg/max/mdev = 2.473/4.019/5.307/0.771 ms
```
```
[toto@node1 ~]$ traceroute 10.1.2.11
traceroute to 10.1.2.11 (10.1.2.11), 30 hops max, 60 byte packets
 1  10.1.1.254 (10.1.1.254)  1.709 ms  2.440 ms  1.576 ms
 2  10.1.2.11 (10.1.2.11)  3.905 ms !X  5.041 ms !X  3.626 ms !X
```

## II. Interlude accès internet

### ☀️ Sur router.tp2
```
[toto@router ~]$ ping google.com
PING google.com (216.58.214.78) 56(84) bytes of data.
64 bytes from par10s39-in-f14.1e100.net (216.58.214.78): icmp_seq=1 ttl=116 time=17.5 ms
64 bytes from par10s39-in-f14.1e100.net (216.58.214.78): icmp_seq=2 ttl=116 time=21.8 ms
64 bytes from par10s39-in-f14.1e100.net (216.58.214.78): icmp_seq=3 ttl=116 time=18.0 ms
^C
--- google.com ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2005ms
rtt min/avg/max/mdev = 17.511/19.116/21.802/1.911 ms
[toto@router ~]$ ping 1.1.1.1
PING 1.1.1.1 (1.1.1.1) 56(84) bytes of data.
64 bytes from 1.1.1.1: icmp_seq=1 ttl=54 time=23.6 ms
64 bytes from 1.1.1.1: icmp_seq=2 ttl=54 time=18.0 ms
64 bytes from 1.1.1.1: icmp_seq=3 ttl=54 time=18.8 ms
^C
--- 1.1.1.1 ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2006ms
rtt min/avg/max/mdev = 17.960/20.122/23.626/2.500 ms
```
### ☀️ Accès internet LAN1 et LAN2
```
[toto@node2lan1 ~]$ sudo cat /etc/sysconfig/network-scripts/route-enp0s3
10.1.2.0/24 via 10.1.1.254 dev enp0s3
default via 10.1.1.254 dev enp0s3
```
```
[toto@node2lan1 ~]$ sudo cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 8.8.8.8
nameserver 1.1.1.1
```
```
[toto@node2lan1 ~]$ ping gitlab.com
PING gitlab.com (172.65.251.78) 56(84) bytes of data.
64 bytes from 172.65.251.78 (172.65.251.78): icmp_seq=1 ttl=53 time=29.0 ms
64 bytes from 172.65.251.78 (172.65.251.78): icmp_seq=2 ttl=53 time=28.1 ms
64 bytes from 172.65.251.78 (172.65.251.78): icmp_seq=3 ttl=53 time=29.8 ms
64 bytes from 172.65.251.78 (172.65.251.78): icmp_seq=4 ttl=53 time=27.3 ms
^C
--- gitlab.com ping statistics ---
4 packets transmitted, 4 received, 0% packet loss, time 3034ms
rtt min/avg/max/mdev = 27.341/28.568/29.804/0.934 ms
[toto@node2lan1 ~]$ ping 8.8.8.8
PING 8.8.8.8 (8.8.8.8) 56(84) bytes of data.
64 bytes from 8.8.8.8: icmp_seq=1 ttl=112 time=24.1 ms
64 bytes from 8.8.8.8: icmp_seq=2 ttl=112 time=26.2 ms
64 bytes from 8.8.8.8: icmp_seq=3 ttl=112 time=26.2 ms
^C
--- 8.8.8.8 ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2006ms
rtt min/avg/max/mdev = 24.137/25.496/26.192/0.961 ms
```
## III. Services réseau

### ☀️ Sur web.lan2.tp2
```
[toto@weblan2 ~]$ sudo cat /var/www/site_nul/index.html
Bienvenue sur le site nul
[toto@weblan2 ~]$ sudo cat /etc/nginx/conf.d/site_nul
server {
  # le port sur lequel on veut écouter
  listen 80;

  # le nom de la page d'accueil si le client de la précise pas
  index index.html;

  # un nom pour notre serveur (pas vraiment utile ici, mais bonne pratique)
  server_name www.site_nul;

  # le dossier qui contient notre site web
  root /var/www/site_nul;
}
[toto@weblan2 ~]$ sudo firewall-cmd --list-all
public (active)
  target: default
  icmp-block-inversion: no
  interfaces: enp0s3
  sources:
  services: cockpit dhcpv6-client ssh
  ports: 22/tcp 80/tcp
  protocols:
  forward: yes
  masquerade: no
  forward-ports:
  source-ports:
  icmp-blocks:
  rich rules:
[toto@weblan2 ~]$ sudo systemctl status nginx
● nginx.service - The nginx HTTP and reverse proxy server
     Loaded: loaded (/usr/lib/systemd/system/nginx.service; disabled; preset: disabled)
     Active: active (running) since Fri 2024-10-04 09:34:07 CEST; 8s ago
    Process: 11230 ExecStartPre=/usr/bin/rm -f /run/nginx.pid (code=exited, status=0/SUCCESS)
    Process: 11231 ExecStartPre=/usr/sbin/nginx -t (code=exited, status=0/SUCCESS)
    Process: 11232 ExecStart=/usr/sbin/nginx (code=exited, status=0/SUCCESS)
   Main PID: 11233 (nginx)
      Tasks: 2 (limit: 4674)
     Memory: 1.9M
        CPU: 102ms
     CGroup: /system.slice/nginx.service
             ├─11233 "nginx: master process /usr/sbin/nginx"
             └─11234 "nginx: worker process"

Oct 04 09:34:07 weblan2 systemd[1]: Starting The nginx HTTP and reverse proxy server...
Oct 04 09:34:07 weblan2 nginx[11231]: nginx: the configuration file /etc/nginx/nginx.conf syntax is ok
Oct 04 09:34:07 weblan2 nginx[11231]: nginx: configuration file /etc/nginx/nginx.conf test is success>
Oct 04 09:34:07 weblan2 systemd[1]: Started The nginx HTTP and reverse proxy server.
[toto@weblan2 ~]$ sudo ss -tlnp | grep ':80'
LISTEN 0      511          0.0.0.0:80        0.0.0.0:*    users:(("nginx",pid=11234,fd=6),("nginx",pid=11233,fd=6))
LISTEN 0      511             [::]:80           [::]:*    users:(("nginx",pid=11234,fd=7),("nginx",pid=11233,fd=7))
```
### ☀️ Sur node1.lan1.tp2
```
[toto@node1lan1 ~]$ sudo cat /etc/hosts
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
10.1.2.12   site_nul.tp2
```
```
[toto@node1lan1 ~]$ curl site_nul.tp2
<!doctype html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <title>HTTP Server Test Page powered by: Rocky Linux</title>
    <style type="text/css">
      /*<![CDATA[*/

      html {
        height: 100%;
        width: 100%;
      }
   .......trop long
```
## 2. Or is it ? Bonus : DHCP

### ☀️ Sur dhcp.lan1.tp2
```
[toto@dhcplan1 ~]$ sudo dnf install dhcp-server
```
```
[toto@dhcplan1 ~]$ ip a
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
2: enp0s3: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000
    link/ether 08:00:27:7c:0a:2d brd ff:ff:ff:ff:ff:ff
    inet 10.1.1.12/24 brd 10.1.1.255 scope global noprefixroute enp0s3
       valid_lft forever preferred_lft forever
    inet 10.1.1.253/24 brd 10.1.1.255 scope global secondary noprefixroute enp0s3
       valid_lft forever preferred_lft forever
    inet6 fe80::a00:27ff:fe7c:a2d/64 scope link
       valid_lft forever preferred_lft forever
```
```
[toto@dhcplan1 ~]$ sudo cat /etc/dhcp/dhcpd.conf
# create new
# specify domain name
option domain-name     "site_nul";
# specify DNS server's hostname or IP address
option domain-name-servers     dlp.site_nul;
# default lease time
default-lease-time 600;
# max lease time
max-lease-time 7200;
# this DHCP server to be declared valid
authoritative;
# specify network address and subnetmask
subnet 10.1.1.0 netmask 255.255.255.0 {
    # specify the range of lease IP address
    range dynamic-bootp 10.1.1.100 10.1.1.200;
    # specify broadcast address
    option broadcast-address 10.1.1.255;
    # specify gateway
    option routers 10.1.1.254;
}
```
```
[toto@dhcplan1 ~]$ ll /var/lib/dhcpd
total 8
-rw-r--r-- 1 dhcpd dhcpd   0 Oct 26  2023 dhcpd6.leases
-rw-r--r-- 1 dhcpd dhcpd 280 Oct  4 09:58 dhcpd.leases
-rw-r--r-- 1 dhcpd dhcpd 221 Oct  4 09:57 dhcpd.leases~
```

### ☀️ Sur node1.lan1.tp2
```
[toto@node1lan1 ~]$ sudo cat /etc/sysconfig/network-scripts/ifcfg-enp0s3
DEVICE=enp0s3

BOOTPROTO=dhcp
ONBOOT=yes
```
```
[toto@node1lan1 ~]$ ip a
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
2: enp0s3: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000
    link/ether 08:00:27:66:1a:e5 brd ff:ff:ff:ff:ff:ff
    inet 10.1.1.100/24 brd 10.1.1.255 scope global dynamic noprefixroute enp0s3
       valid_lft 504sec preferred_lft 504sec
    inet6 fe80::a00:27ff:fe66:1ae5/64 scope link
       valid_lft forever preferred_lft forever
```
```
[toto@node1lan1 ~]$ journalctl | grep dhcp
Oct 04 09:03:58 node1lan1 NetworkManager[673]: <info>  [1728025438.3952] dhcp: init: Using DHCP client 'internal'
Oct 04 09:15:34 node1lan1 NetworkManager[1312]: <info>  [1728026134.6454] dhcp: init: Using DHCP client 'internal'
Oct 04 10:02:40 node1lan1 NetworkManager[1312]: <info>  [1728028960.3227] dhcp4 (enp0s3): activation: beginning transaction (timeout in 45 seconds)
Oct 04 10:02:41 node1lan1 NetworkManager[1312]: <info>  [1728028961.6511] dhcp4 (enp0s3): state changed new lease, address=10.1.1.100
```
```
[toto@node1lan1 ~]$ ping 10.1.2.11
PING 10.1.2.11 (10.1.2.11) 56(84) bytes of data.
64 bytes from 10.1.2.11: icmp_seq=1 ttl=63 time=2.81 ms
64 bytes from 10.1.2.11: icmp_seq=2 ttl=63 time=3.97 ms
64 bytes from 10.1.2.11: icmp_seq=3 ttl=63 time=4.29 ms
^C
--- 10.1.2.11 ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2004ms
rtt min/avg/max/mdev = 2.806/3.688/4.285/0.636 ms
```